<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>冒泡排序算法人机交互可视化演示 - 学习增强版</title>
    <style>
        :root {
            --input-bg: #e3f2fd;
            --visualization-bg: #f5f5f5;
            --code-bg: #f8f9fa;
            --control-bg: #e8f5e9;
            --info-bg: #fff3e0;
            --stats-bg: #fce4ec;
            --notes-bg: #f3e5f5;
            --border-color: #ddd;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-color: #f9f9f9;
            padding: 20px;
            color: #333;
        }
        
        .main-title {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 24px;
            font-weight: bold;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .row {
            display: flex;
            gap: 20px;
            width: 100%;
        }
        
        .row-single {
            width: 100%;
        }
        
        .col {
            flex: 1;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid rgba(0,0,0,0.1);
            padding-bottom: 8px;
        }
        
        /* 数据输入模块样式 */
        .input-panel {
            background-color: var(--input-bg);
        }
        
        .input-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group label {
            width: 100px;
            font-size: 14px;
        }
        
        .input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            background-color: #4285f4;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-random {
            background-color: #34a853;
        }
        
        .btn-manual {
            background-color: #ea4335;
        }
        
        .btn-submit {
            background-color: #fbbc05;
        }
        
        /* 冒泡排序思想面板 */
        .concept-panel {
            background-color: #fff8e1;
            height: 100%;
            padding: 15px;
            border-radius: 8px;
        }
        
        .concept-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #5c6bc0;
        }
        
        .concept-content {
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* 语音控制模块 */
        .voice-panel {
            background-color: #e8eaf6;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
        }
        
        .voice-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .voice-control label {
            font-size: 14px;
            font-weight: 500;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #5c6bc0;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* 算法可视化模块 */
        .visualization-panel {
            background-color: var(--visualization-bg);
            min-height: 350px;
            padding: 20px;
        }
        
        .visualization-container {
            height: 300px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 15px;
            padding: 10px;
            overflow-x: auto;
        }
        
        .bar {
            width: 40px;
            min-width: 30px;
            background-color: #64B5F6;
            position: relative;
            transition: height 0.3s, background-color 0.3s;
            border-radius: 4px 4px 0 0;
        }
        
        .bar.current {
            background-color: #FFA726;
        }
        
        .bar.completed {
            background-color: #81C784;
        }
        
        .bar-value {
            position: absolute;
            bottom: -25px;
            width: 100%;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        /* 算法代码模块 */
        .code-panel {
            background-color: var(--code-bg);
            height: 100%;
        }
        
        .code-container {
            flex: 1;
            background-color: #263238;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #e0e0e0;
            overflow: hidden;
        }
        
        .code-line {
            display: flex;
            margin-bottom: 5px;
        }
        
        .line-number {
            width: 30px;
            color: #78909c;
            text-align: right;
            padding-right: 15px;
            user-select: none;
        }
        
        .line-code {
            flex: 1;
            white-space: pre;
        }
        
        .keyword {
            color: #ff5370;
        }
        
        .function {
            color: #82aaff;
        }
        
        .comment {
            color: #546e7a;
            font-style: italic;
        }
        
        .highlight {
            background-color: #2c3b41;
            box-shadow: 0 0 0 2px #ffcb6b;
        }
        
        /* 当前执行信息模块 */
        .info-panel {
            background-color: var(--info-bg);
            padding: 15px;
            border-radius: 8px;
            flex: 1;
        }
        
        .info-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .info-item {
            display: flex;
        }
        
        .info-label {
            width: 100px;
            font-size: 14px;
            color: #5d4037;
        }
        
        .info-value {
            flex: 1;
            font-size: 14px;
            font-weight: bold;
            color: #3e2723;
        }
        
        /* 算法控制模块 */
        .control-panel {
            background-color: var(--control-bg);
            padding: 15px;
            border-radius: 8px;
            flex: 1;
        }
        
        .control-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-start {
            background-color: #4CAF50;
        }
        
        .btn-step {
            background-color: #FF9800;
        }
        
        .btn-auto {
            background-color: #9C27B0;
        }
        
        .btn-pause {
            background-color: #607D8B;
        }
        
        .btn-reset {
            background-color: #f44336;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .speed-control label {
            font-size: 14px;
            color: #2e7d32;
        }
        
        .speed-slider {
            flex: 1;
        }
        
        .speed-value {
            width: 60px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #1b5e20;
        }
        
        /* 算法性能统计模块 */
        .stats-panel {
            background-color: var(--stats-bg);
        }
        
        .stats-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            border: 1px solid #f48fb1;
            padding: 8px 12px;
            text-align: center;
        }
        
        th {
            background-color: #f8bbd0;
            color: #880e4f;
        }
        
        tr:nth-child(even) {
            background-color: #fce4ec;
        }
        
        tr:hover {
            background-color: #f8bbd0;
        }
        
        .summary {
            margin-top: 15px;
            font-size: 14px;
            padding: 10px;
            background-color: #f8bbd0;
            border-radius: 4px;
        }
        
        .summary-item {
            display: flex;
            margin-bottom: 5px;
        }
        
        .summary-label {
            width: 120px;
            font-weight: bold;
            color: #880e4f;
        }
        
        .summary-value {
            flex: 1;
            font-weight: bold;
            color: #4a148c;
        }
        
        /* 记事本模块 */
        .notes-panel {
            background-color: var(--notes-bg);
        }
        
        .notes-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .notes-textarea {
            height: 150px;
            width: 100%;
            padding: 12px;
            border: 1px solid #ce93d8;
            border-radius: 4px;
            resize: vertical;
            font-size: 14px;
            background-color: white;
        }
        
        .notes-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-save {
            background-color: #7e57c2;
        }
        
        .btn-load {
            background-color: #26a69a;
        }
        
        .btn-clear {
            background-color: #ef5350;
        }
        
        /* 完成提示 */
        .completion-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #4caf50;
            color: white;
            padding: 20px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            animation: fadeInOut 3s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* 按钮图标 */
        .btn-icon {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
        
        /* 新增学习辅助样式 */
        .learning-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
        }
        
        .mark-btn {
            background-color: #7e57c2;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .mark-btn:hover {
            transform: scale(1.1);
            background-color: #9575cd;
        }
        
        .mark-btn svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        
        .mark-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1002;
            width: 400px;
            max-width: 90%;
            display: none;
        }
        
        .mark-popup h3 {
            margin-bottom: 15px;
            color: #5c6bc0;
        }
        
        .mark-textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            margin-bottom: 15px;
        }
        
        .mark-popup-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .mark-popup-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .mark-popup-save {
            background-color: #5c6bc0;
            color: white;
        }
        
        .mark-popup-cancel {
            background-color: #e0e0e0;
        }
        
        .marked-bar {
            box-shadow: 0 0 0 3px #ff5722;
            position: relative;
        }
        
        .mark-indicator {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ff5722;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .mark-list {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }
        
        .mark-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .mark-list-title {
            font-weight: bold;
            color: #5c6bc0;
        }
        
        .mark-list-close {
            cursor: pointer;
            color: #999;
        }
        
        .mark-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .mark-item:hover {
            background-color: #f5f5f5;
        }
        
        .mark-item-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .mark-item-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .mark-item-time {
            font-size: 11px;
            color: #999;
            text-align: right;
        }
        
        .view-marks-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background-color: #26a69a;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 1001;
        }
        
        .view-marks-btn:hover {
            transform: scale(1.1);
            background-color: #4db6ac;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            
            .visualization-container {
                height: 200px;
            }
            
            .code-container, .info-container, .control-container {
                height: auto;
            }
            
            .btn-group, .control-buttons, .notes-buttons {
                flex-wrap: wrap;
            }
            
            .btn {
                flex: 1;
                min-width: 100px;
            }
            
            .mark-popup {
                width: 90%;
            }
            
            .mark-list {
                width: 90%;
                left: 50%;
                transform: translateX(-50%);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="main-title">冒泡排序算法人机交互可视化演示</h1>
        
        <!-- 第一层：数据输入和冒泡排序思想 -->
        <div class="row">
            <div class="col input-panel">
                <div class="panel-title">数据输入模块</div>
                <div class="input-section">
                    <div class="input-group">
                        <label for="element-count">元素个数:</label>
                        <input type="number" id="element-count" min="3" max="30" value="10">
                    </div>
                    <div class="btn-group">
                        <button id="random-btn" class="btn btn-random">
                            <svg class="btn-icon" viewBox="0 0 24 24"><path d="M12,6V9L16,5L12,1V4A8,8 0 0,0 4,12C4,13.57 4.46,15.03 5.24,16.26L6.7,14.8C6.25,13.97 6,13 6,12A6,6 0 0,1 12,6M18.76,7.74L17.3,9.2C17.74,10.04 18,11 18,12A6,6 0 0,1 12,18V15L8,19L12,23V20A8,8 0 0,0 20,12C20,10.43 19.54,8.97 18.76,7.74Z"/></svg>
                            随机生成数据
                        </button>
                        <button id="manual-btn" class="btn btn-manual">
                            <svg class="btn-icon" viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
                            手动输入数据
                        </button>
                    </div>
                    <div id="manual-input-container" style="display: none;">
                        <div class="input-group">
                            <label for="manual-input">输入数据 (逗号分隔):</label>
                            <input type="text" id="manual-input" placeholder="例如: 5,3,8,1,2">
                        </div>
                        <button id="submit-btn" class="btn btn-submit">
                            <svg class="btn-icon" viewBox="0 0 24 24"><path d="M9,16.17L4.83,12L3.41,13.41L9,19L21,7L19.59,5.59L9,16.17Z"/></svg>
                            提交数据
                        </button>
                    </div>
                </div>
            </div>
            <div class="col concept-panel">
                <div class="concept-title">冒泡排序算法思想</div>
                <div class="concept-content">
                    <p>冒泡排序是一种简单的排序算法，它重复地遍历要排序的数列，一次比较两个元素，如果它们的顺序错误就把它们交换过来。</p>
                    <p>算法步骤：</p>
                    <ol>
                        <li>比较相邻的元素。如果第一个比第二个大，就交换它们。</li>
                        <li>对每一对相邻元素作同样的工作，从开始第一对到结尾的最后一对。</li>
                        <li>针对所有的元素重复以上的步骤，除了最后一个。</li>
                        <li>持续每次对越来越少的元素重复上面的步骤，直到没有任何一对数字需要比较。</li>
                    </ol>
                </div>
            </div>
        </div>
        
        <!-- 第二层：算法可视化 -->
        <div class="row-single">
            <div class="col visualization-panel">
                <div class="panel-title">算法可视化模块</div>
                <div id="visualization" class="visualization-container"></div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #64B5F6;"></div>
                        <span>未执行</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FFA726;"></div>
                        <span>当前执行</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #81C784;"></div>
                        <span>已完成</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 第三层：算法代码和控制 -->
        <div class="row">
            <div class="col code-panel">
                <div class="panel-title">算法代码模块</div>
                <div class="code-container" id="code-container">
                    <div class="code-line"><div class="line-number">1</div><div class="line-code"><span class="comment">// 冒泡排序函数，接收一个数组作为参数</span></div></div>
                    <div class="code-line"><div class="line-number">2</div><div class="line-code"><span class="keyword">function</span> <span class="function">bubbleSort</span>(arr) {</div></div>
                    <div class="code-line"><div class="line-number">3</div><div class="line-code">  <span class="keyword">let</span> n = arr.<span class="keyword">length</span>; <span class="comment">// 获取数组长度</span></div></div>
                    <div class="code-line"><div class="line-number">4</div><div class="line-code">  <span class="keyword">for</span> (<span class="keyword">let</span> i = 0; i &lt; n - 1; i++) { <span class="comment">// 外层循环控制排序趟数</span></div></div>
                    <div class="code-line"><div class="line-number">5</div><div class="line-code">    <span class="keyword">for</span> (<span class="keyword">let</span> j = 0; j &lt; n - i - 1; j++) { <span class="comment">// 内层循环控制每趟比较次数</span></div></div>
                    <div class="code-line"><div class="line-number">6</div><div class="line-code">      <span class="keyword">if</span> (arr[j] &gt; arr[j + 1]) { <span class="comment">// 比较相邻元素</span></div></div>
                    <div class="code-line"><div class="line-number">7</div><div class="line-code">        [arr[j], arr[j + 1]] = [arr[j + 1], arr[j]]; <span class="comment">// 交换元素</span></div></div>
                    <div class="code-line"><div class="line-number">8</div><div class="line-code">      }</div></div>
                    <div class="code-line"><div class="line-number">9</div><div class="line-code">    }</div></div>
                    <div class="code-line"><div class="line-number">10</div><div class="line-code">  }</div></div>
                    <div class="code-line"><div class="line-number">11</div><div class="line-code">  <span class="keyword">return</span> arr; <span class="comment">// 返回排序后的数组</span></div></div>
                    <div class="code-line"><div class="line-number">12</div><div class="line-code">}</div></div>
                </div>
            </div>
            <div class="col" style="display: flex; flex-direction: column; gap: 20px;">
                <div class="info-panel">
                    <div class="panel-title">当前执行信息</div>
                    <div class="info-container">
                        <div class="info-item">
                            <div class="info-label">状态:</div>
                            <div class="info-value" id="status">未开始</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">当前操作:</div>
                            <div class="info-value" id="current-op">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">执行行号:</div>
                            <div class="info-value" id="current-line">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">运行时间:</div>
                            <div class="info-value" id="run-time">0 ms</div>
                        </div>
                    </div>
                </div>
                <div class="control-panel">
                    <div class="panel-title">算法控制模块</div>
                    <div class="control-container">
                        <div class="control-buttons">
                            <button id="start-btn" class="btn btn-start">
                                <svg class="btn-icon" viewBox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"/></svg>
                                开始
                            </button>
                            <button id="step-btn" class="btn btn-step" disabled>
                                <svg class="btn-icon" viewBox="0 0 24 24"><path d="M3,5V19H11V17H5V7H11V5H3M13,5V19H21V17H15V7H21V5H13Z"/></svg>
                                单步运行
                            </button>
                            <button id="auto-btn" class="btn btn-auto" disabled>
                                <svg class="btn-icon" viewBox="0 0 24 24"><path d="M14,12A2,2 0 0,0 12,14A2,2 0 0,0 14,16A2,2 0 0,0 16,14A2,2 0 0,0 14,12M8,12A2,2 0 0,0 6,14A2,2 0 0,0 8,16A2,2 0 0,0 10,14A2,2 0 0,0 8,12M20,12A2,2 0 0,0 18,14A2,2 0 0,0 20,16A2,2 0 0,0 22,14A2,2 0 0,0 20,12Z"/></svg>
                                自动运行
                            </button>
                            <button id="pause-btn" class="btn btn-pause" disabled>
                                <svg class="btn-icon" viewBox="0 0 24 24"><path d="M14,19H18V5H14M6,19H10V5H6V19Z"/></svg>
                                暂停
                            </button>
                            <button id="reset-btn" class="btn btn-reset">
                                <svg class="btn-icon" viewBox="0 0 24 24"><path d="M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg>
                                重置
                            </button>
                        </div>
                        <div class="speed-control">
                            <label for="speed-slider">执行速度:</label>
                            <input type="range" id="speed-slider" min="100" max="2000" step="100" value="500" class="speed-slider">
                            <span id="speed-value" class="speed-value">500 ms</span>
                        </div>
                    </div>
                </div>
                <div class="voice-panel">
                    <div class="panel-title">语音控制模块</div>
                    <div class="voice-control">
                        <label for="voice-toggle">启用语音讲解:</label>
                        <label class="switch">
                            <input type="checkbox" id="voice-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 第四层：算法性能统计 -->
        <div class="row-single">
            <div class="col stats-panel">
                <div class="panel-title">算法性能统计</div>
                <div class="stats-container">
                    <table id="stats-table">
                        <thead>
                            <tr>
                                <th>序号</th>
                                <th>趟数</th>
                                <th>比较次数</th>
                                <th>交换次数</th>
                                <th>执行行号</th>
                                <th>运行时间</th>
                            </tr>
                        </thead>
                        <tbody id="stats-body">
                            <!-- 统计数据将在这里动态添加 -->
                        </tbody>
                    </table>
                    <div class="summary" id="summary">
                        <!-- 统计摘要将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 第五层：记事本模块 -->
        <div class="row-single">
            <div class="col notes-panel">
                <div class="panel-title">记事本模块</div>
                <div class="notes-container">
                    <textarea id="notes-textarea" class="notes-textarea" placeholder="在这里记录你的学习笔记..."></textarea>
                    <div class="notes-buttons">
                        <button id="save-btn" class="btn btn-save">
                            <svg class="btn-icon" viewBox="0 0 24 24"><path d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"/></svg>
                            保存笔记
                        </button>
                        <button id="load-btn" class="btn btn-load">
                            <svg class="btn-icon" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
                            加载笔记
                        </button>
                        <button id="clear-btn" class="btn btn-clear">
                            <svg class="btn-icon" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
                            清空笔记
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 完成提示 -->
        <div id="completion-message" class="completion-message">
            排序已完成！
        </div>
    </div>

    <!-- 新增学习辅助功能 -->
    <div class="learning-assistant">
        <button class="mark-btn" id="mark-btn" title="标记当前步骤">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M18.5,12A3.5,3.5 0 0,1 22,15.5A3.5,3.5 0 0,1 18.5,19A3.5,3.5 0 0,1 15,15.5A3.5,3.5 0 0,1 18.5,12M18.5,4A3.5,3.5 0 0,1 22,7.5A3.5,3.5 0 0,1 18.5,11A3.5,3.5 0 0,1 15,7.5A3.5,3.5 0 0,1 18.5,4M18.5,16A1.5,1.5 0 0,0 17,17.5A1.5,1.5 0 0,0 18.5,19A1.5,1.5 0 0,0 20,17.5A1.5,1.5 0 0,0 18.5,16M10,4A4,4 0 0,1 14,8A4,4 0 0,1 10,12A4,4 0 0,1 6,8A4,4 0 0,1 10,4M10,14C11.15,14 12.25,14.12 13.24,14.34C12.46,15.35 12,16.62 12,18C12,18.7 12.12,19.37 12.34,20C12.23,20 12.12,20 12,20C7.58,20 4,16.42 4,12C4,7.58 7.58,4 12,4C16.42,4 20,7.58 20,12C20,12.12 20,12.23 20,12.34C19.37,12.12 18.7,12 18,12C16.62,12 15.35,12.46 14.34,13.24C14.12,12.25 14,11.15 14,10C14,8.43 14.47,6.92 15.34,5.66C14.42,5.25 13.31,5 12,5A7,7 0 0,0 5,12A7,7 0 0,0 12,19C12.31,19 12.61,19 12.91,18.97C12.96,18.68 13,18.34 13,18C13,16.82 12.78,15.67 12.33,14.61C11.5,14.23 10.78,14 10,14Z"/></svg>
            标记
        </button>
    </div>
    
    <button class="view-marks-btn" id="view-marks-btn" title="查看标记记录">
        <svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M15,13H16.5V15.82L18.94,17.23L18.19,18.53L15,16.69V13M19,8H5V19H9.67C9.24,18.09 9,17.07 9,16A7,7 0 0,1 16,9C17.07,9 18.09,9.24 19,9.67V8M5,21C3.89,21 3,20.1 3,19V5C3,3.89 3.89,3 5,3H6V1H8V3H16V1H18V3H19A2,2 0 0,1 21,5V11.1C22.24,12.36 23,14.09 23,16A7,7 0 0,1 16,23C14.09,23 12.36,22.24 11.1,21H5M16,11.15A4.85,4.85 0 0,0 11.15,16C11.15,18.68 13.32,20.85 16,20.85A4.85,4.85 0 0,0 20.85,16C20.85,13.32 18.68,11.15 16,11.15Z"/></svg>
    </button>
    
    <div class="mark-popup" id="mark-popup">
        <h3>标记当前步骤</h3>
        <div class="mark-info" id="mark-info"></div>
        <textarea class="mark-textarea" id="mark-textarea" placeholder="请记录你不理解的内容或问题..."></textarea>
        <div class="mark-popup-buttons">
            <button class="mark-popup-btn mark-popup-cancel" id="mark-cancel-btn">取消</button>
            <button class="mark-popup-btn mark-popup-save" id="mark-save-btn">保存</button>
        </div>
    </div>
    
    <div class="mark-list" id="mark-list">
        <div class="mark-list-header">
            <div class="mark-list-title">标记记录</div>
            <div class="mark-list-close" id="mark-list-close">×</div>
        </div>
        <div class="mark-list-content" id="mark-list-content">
            <!-- 标记记录将在这里动态添加 -->
        </div>
    </div>

    <script>
        // 全局变量
        let originalArray = [];
        let currentArray = [];
        let animationSteps = [];
        let currentStep = 0;
        let isAutoRunning = false;
        let animationInterval = null;
        let startTime = 0;
        let passStartTime = 0;
        let totalComparisons = 0;
        let totalSwaps = 0;
        let passCount = 0;
        let statsData = [];
        let speechEnabled = false;
        let speechSynthesis = window.speechSynthesis;
        let isStarted = false;
        
        // DOM元素
        const elementCountInput = document.getElementById('element-count');
        const randomBtn = document.getElementById('random-btn');
        const manualBtn = document.getElementById('manual-btn');
        const manualInputContainer = document.getElementById('manual-input-container');
        const manualInput = document.getElementById('manual-input');
        const submitBtn = document.getElementById('submit-btn');
        const visualization = document.getElementById('visualization');
        const startBtn = document.getElementById('start-btn');
        const stepBtn = document.getElementById('step-btn');
        const autoBtn = document.getElementById('auto-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const speedSlider = document.getElementById('speed-slider');
        const speedValue = document.getElementById('speed-value');
        const statusDisplay = document.getElementById('status');
        const currentOpDisplay = document.getElementById('current-op');
        const currentLineDisplay = document.getElementById('current-line');
        const runTimeDisplay = document.getElementById('run-time');
        const statsBody = document.getElementById('stats-body');
        const summaryDisplay = document.getElementById('summary');
        const notesTextarea = document.getElementById('notes-textarea');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const clearBtn = document.getElementById('clear-btn');
        const voiceToggle = document.getElementById('voice-toggle');
        const codeLines = document.querySelectorAll('.code-line');
        const completionMessage = document.getElementById('completion-message');
        
        // 新增学习辅助功能DOM元素
        const markBtn = document.getElementById('mark-btn');
        const viewMarksBtn = document.getElementById('view-marks-btn');
        const markPopup = document.getElementById('mark-popup');
        const markInfo = document.getElementById('mark-info');
        const markTextarea = document.getElementById('mark-textarea');
        const markSaveBtn = document.getElementById('mark-save-btn');
        const markCancelBtn = document.getElementById('mark-cancel-btn');
        const markList = document.getElementById('mark-list');
        const markListContent = document.getElementById('mark-list-content');
        const markListClose = document.getElementById('mark-list-close');
        
        // 标记数据存储
        let marks = JSON.parse(localStorage.getItem('bubbleSortMarks')) || [];
        
        // 初始化
        function init() {
            // 修改标记数据的加载方式，只在页面首次加载时读取
            marks = [];
            localStorage.removeItem('bubbleSortMarks');
            
            // 其他原有初始化代码保持不变
            randomBtn.addEventListener('click', generateRandomData);
            manualBtn.addEventListener('click', toggleManualInput);
            submitBtn.addEventListener('click', submitManualData);
            startBtn.addEventListener('click', startSorting);
            stepBtn.addEventListener('click', stepForward);
            autoBtn.addEventListener('click', startAutoRun);
            pauseBtn.addEventListener('click', pauseAutoRun);
            resetBtn.addEventListener('click', resetAll);
            speedSlider.addEventListener('input', updateSpeed);
            saveBtn.addEventListener('click', saveNotes);
            loadBtn.addEventListener('click', loadNotes);
            clearBtn.addEventListener('click', clearNotes);
            voiceToggle.addEventListener('change', toggleVoice);
            
            // 新增学习辅助功能事件监听
            markBtn.addEventListener('click', showMarkPopup);
            viewMarksBtn.addEventListener('click', showMarkList);
            markSaveBtn.addEventListener('click', saveMark);
            markCancelBtn.addEventListener('click', closeMarkPopup);
            markListClose.addEventListener('click', closeMarkList);
            
            updateSpeed();
            
            // 检测浏览器是否支持语音合成
            if (!speechSynthesis) {
                voiceToggle.disabled = true;
                voiceToggle.parentElement.querySelector('span').textContent = '语音不支持';
            }
            
            // 初始渲染
            renderBars();
            renderMarkList();
        }
        
        // 原功能函数保持不变...
        
        // 生成随机数据
        function generateRandomData() {
            const count = parseInt(elementCountInput.value);
            if (isNaN(count)) {
                alert('请输入有效的数字');
                return;
            }
            
            if (count < 3 || count > 30) {
                alert('请输入3到30之间的数字');
                return;
            }
            
            originalArray = [];
            for (let i = 0; i < count; i++) {
                originalArray.push(Math.floor(Math.random() * 90) + 10); // 10-99之间的随机数
            }
            
            setupVisualization();
            
            // 语音提示
            if (speechEnabled) {
                speak(`已随机生成${count}个数据`);
            }
        }
        
        // 切换手动输入
        function toggleManualInput() {
            manualInputContainer.style.display = manualInputContainer.style.display === 'none' ? 'block' : 'none';
            
            // 语音提示
            if (speechEnabled) {
                speak(manualInputContainer.style.display === 'none' ? '已关闭手动输入' : '请输入数据，用逗号分隔');
            }
        }
        
        // 提交手动输入数据
        function submitManualData() {
            const inputText = manualInput.value.trim();
            if (!inputText) {
                alert('请输入数据');
                return;
            }
            
            const inputArray = inputText.split(',').map(item => parseInt(item.trim()));
            if (inputArray.some(isNaN)) {
                alert('请输入有效的数字，用逗号分隔');
                return;
            }
            
            if (inputArray.length < 3 || inputArray.length > 30) {
                alert('请输入3到30个数字');
                return;
            }
            
            originalArray = inputArray;
            elementCountInput.value = inputArray.length;
            manualInputContainer.style.display = 'none';
            
            setupVisualization();
            
            // 语音提示
            if (speechEnabled) {
                speak(`已提交${inputArray.length}个数据`);
            }
        }
        
        // 开始排序
        function startSorting() {
            if (originalArray.length === 0) {
                alert('请先生成或输入数据');
                return;
            }
            
            isStarted = true;
            startBtn.disabled = true;
            stepBtn.disabled = false;
            autoBtn.disabled = false;
            passStartTime = Date.now();
            
            // 语音提示
            if (speechEnabled) {
                speak('排序已开始');
            }
        }
        
        // 设置可视化
        function setupVisualization() {
            if (originalArray.length === 0) return;
            
            currentArray = [...originalArray];
            animationSteps = [];
            currentStep = 0;
            totalComparisons = 0;
            totalSwaps = 0;
            passCount = 0;
            statsData = [];
            isStarted = false;
            
            // 生成冒泡排序的动画步骤
            generateBubbleSortSteps([...originalArray]);
            
            // 渲染初始状态
            renderBars();
            updateStatsTable();
            updateSummary();
            
            // 更新状态
            updateStatus('准备就绪');
            updateCurrentOp('-');
            updateCurrentLine('-');
            updateRunTime(0);
            
            // 重置代码高亮
            resetCodeHighlight();
            
            // 重置按钮状态
            startBtn.disabled = false;
            stepBtn.disabled = true;
            autoBtn.disabled = true;
            pauseBtn.disabled = true;
        }
        
        // 生成冒泡排序的动画步骤
        function generateBubbleSortSteps(arr) {
            const steps = [];
            const n = arr.length;
            let comparisons = 0;
            let swaps = 0;
            let currentPass = 0;
            
            // 初始状态
            steps.push({
                array: [...arr],
                type: 'init',
                comparisons: 0,
                swaps: 0,
                pass: 0,
                line: 1,
                op: '初始化排序数组'
            });
            
            for (let i = 0; i < n - 1; i++) {
                currentPass++;
                let passSwaps = 0;
                let passComparisons = 0;
                
                steps.push({
                    array: [...arr],
                    type: 'pass-start',
                    comparisons: comparisons,
                    swaps: swaps,
                    pass: currentPass,
                    line: 4,
                    op: `开始第 ${currentPass} 趟排序`
                });
                
                for (let j = 0; j < n - i - 1; j++) {
                    passComparisons++;
                    comparisons++;
                    
                    steps.push({
                        array: [...arr],
                        type: 'compare',
                        comparisons: comparisons,
                        swaps: swaps,
                        pass: currentPass,
                        indices: [j, j + 1],
                        line: 6,
                        op: `比较 ${arr[j]} 和 ${arr[j + 1]}`
                    });
                    
                    if (arr[j] > arr[j + 1]) {
                        // 交换元素
                        [arr[j], arr[j + 1]] = [arr[j + 1], arr[j]];
                        swaps++;
                        passSwaps++;
                        
                        steps.push({
                            array: [...arr],
                            type: 'swap',
                            comparisons: comparisons,
                            swaps: swaps,
                            pass: currentPass,
                            indices: [j, j + 1],
                            line: 7,
                            op: `交换 ${arr[j + 1]} 和 ${arr[j]}`
                        });
                    }
                }
                
                steps.push({
                    array: [...arr],
                    type: 'pass-end',
                    comparisons: comparisons,
                    swaps: swaps,
                    pass: currentPass,
                    passComparisons: passComparisons,
                    passSwaps: passSwaps,
                    line: 9,
                    op: `完成第 ${currentPass} 趟排序`,
                    passTime: 0 // 将在执行时更新
                });
                
                // 记录统计信息
                statsData.push({
                    pass: currentPass,
                    comparisons: passComparisons,
                    swaps: passSwaps,
                    line: 9,
                    time: 0 // 将在执行时更新
                });
            }
            
            steps.push({
                array: [...arr],
                type: 'complete',
                comparisons: comparisons,
                swaps: swaps,
                pass: currentPass,
                line: 12,
                op: '排序完成'
            });
            
            animationSteps = steps;
        }
        
        // 渲染柱状图
        function renderBars(highlightIndices = [], completedIndices = []) {
            visualization.innerHTML = '';
            
            if (currentArray.length === 0) return;
            
            const maxValue = Math.max(...currentArray, 10);
            const containerHeight = visualization.clientHeight;
            
            currentArray.forEach((value, index) => {
                const barHeight = (value / maxValue) * (containerHeight - 40);
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${barHeight}px`;
                
                if (highlightIndices.includes(index)) {
                    bar.classList.add('current');
                } else if (completedIndices.includes(index)) {
                    bar.classList.add('completed');
                }
                
                // 检查是否有标记
                const stepMarks = marks.filter(mark => mark.step === currentStep && mark.indices && mark.indices.includes(index));
                if (stepMarks.length > 0) {
                    bar.classList.add('marked-bar');
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'mark-indicator';
                    indicator.textContent = '?';
                    indicator.title = '点击查看标记';
                    bar.appendChild(indicator);
                    
                    indicator.addEventListener('click', function(e) {
                        e.stopPropagation();
                        showMarkDetailsForStep(currentStep);
                    });
                }
                
                const valueLabel = document.createElement('div');
                valueLabel.className = 'bar-value';
                valueLabel.textContent = value;
                
                bar.appendChild(valueLabel);
                visualization.appendChild(bar);
            });
        }
        
        // 单步执行
        function stepForward() {
            if (!isStarted) {
                alert('请先点击"开始"按钮');
                return;
            }
            
            if (currentStep >= animationSteps.length) {
                updateStatus('排序已完成');
                showCompletionMessage();
                return;
            }
            
            const step = animationSteps[currentStep];
            currentArray = [...step.array];
            
            // 更新状态显示
            updateStatus('执行中');
            updateCurrentOp(step.op);
            updateCurrentLine(step.line);
            
            // 更新运行时间
            if (currentStep === 0) {
                startTime = Date.now();
                passStartTime = Date.now();
                updateRunTime(0);
            } else {
                updateRunTime(Date.now() - startTime);
            }
            
            // 高亮当前执行的代码行
            highlightCodeLine(step.line);
            
            // 根据步骤类型渲染不同的高亮效果
            let highlightIndices = [];
            let completedIndices = [];
            
            if (step.type === 'compare' || step.type === 'swap') {
                highlightIndices = step.indices;
            }
            
            if (step.type === 'pass-end') {
                // 完成的部分是数组末尾的 passCount 个元素
                completedIndices = Array.from({length: step.pass}, (_, i) => currentArray.length - 1 - i);
                
                // 更新这一趟的运行时间
                const passTime = Date.now() - passStartTime;
                step.passTime = passTime;
                
                // 更新统计信息
                const statIndex = step.pass - 1;
                if (statIndex < statsData.length) {
                    statsData[statIndex].time = passTime;
                    updateStatsTable();
                    updateSummary();
                }
                
                // 重置下一趟的开始时间
                passStartTime = Date.now();
            }
            
            if (step.type === 'complete') {
                // 所有元素都已完成
                completedIndices = Array.from({length: currentArray.length}, (_, i) => i);
                stepBtn.disabled = true;
                autoBtn.disabled = true;
                pauseBtn.disabled = true;
                
                // 显示完成消息
                showCompletionMessage();
                
                // 语音提示排序完成
                if (speechEnabled) {
                    speak('排序已完成');
                }
            }
            
            renderBars(highlightIndices, completedIndices);
            
            currentStep++;
            
            // 如果是最后一步，更新总统计信息
            if (currentStep === animationSteps.length) {
                updateSummary();
            }
        }
        
        // 显示完成消息
        function showCompletionMessage() {
            completionMessage.style.display = 'block';
            setTimeout(() => {
                completionMessage.style.display = 'none';
            }, 3000);
        }
        
        // 自动运行
        function startAutoRun() {
            if (!isStarted) {
                alert('请先点击"开始"按钮');
                return;
            }
            
            if (isAutoRunning) return;
            
            isAutoRunning = true;
            stepBtn.disabled = true;
            autoBtn.disabled = true;
            pauseBtn.disabled = false;
            
            const speed = parseInt(speedSlider.value);
            animationInterval = setInterval(() => {
                stepForward();
                
                if (currentStep >= animationSteps.length) {
                    pauseAutoRun();
                }
            }, speed);
            
            // 语音提示
            if (speechEnabled) {
                speak('开始自动排序');
            }
        }
        
        // 暂停自动运行
        function pauseAutoRun() {
            if (!isAutoRunning) return;
            
            clearInterval(animationInterval);
            isAutoRunning = false;
            stepBtn.disabled = false;
            autoBtn.disabled = false;
            pauseBtn.disabled = true;
            
            // 语音提示
            if (speechEnabled) {
                speak('已暂停排序');
            }
        }
        
        // 重置所有
        function resetAll() {
            pauseAutoRun();
            currentArray = [...originalArray];
            currentStep = 0;
            startTime = 0;
            passStartTime = 0;
            isStarted = false;
            
            // 清空标记数据
            marks = [];
            localStorage.removeItem('bubbleSortMarks');
            
            renderBars();
            updateStatus('已重置');
            updateCurrentOp('-');
            updateCurrentLine('-');
            updateRunTime(0);
            
            // 重置统计信息
            statsData = [];
            updateStatsTable();
            updateSummary();
            
            // 重置按钮状态
            startBtn.disabled = false;
            stepBtn.disabled = true;
            autoBtn.disabled = true;
            pauseBtn.disabled = true;
            
            resetCodeHighlight();
            
            // 语音提示
            if (speechEnabled) {
                speak('已重置排序');
            }
        }
        
        // 更新速度显示
        function updateSpeed() {
            const speed = parseInt(speedSlider.value);
            speedValue.textContent = `${speed} ms`;
            
            if (isAutoRunning) {
                pauseAutoRun();
                startAutoRun();
            }
        }
        
        // 更新状态
        function updateStatus(status) {
            statusDisplay.textContent = status;
        }
        
        // 更新当前操作
        function updateCurrentOp(op) {
            currentOpDisplay.textContent = op;
            
            // 语音播报
            if (speechEnabled && op !== '-') {
                speak(op);
            }
        }
        
        // 更新当前行号
        function updateCurrentLine(line) {
            currentLineDisplay.textContent = line;
        }
        
        // 更新运行时间
        function updateRunTime(time) {
            runTimeDisplay.textContent = `${time} ms`;
        }
        
        // 高亮代码行
        function highlightCodeLine(lineNumber) {
            // 移除所有高亮
            codeLines.forEach(line => {
                line.classList.remove('highlight');
            });
            
            // 高亮当前行
            if (lineNumber >= 1 && lineNumber <= codeLines.length) {
                codeLines[lineNumber - 1].classList.add('highlight');
                
                // 滚动到可见区域
                const codeContainer = document.getElementById('code-container');
                const lineElement = codeLines[lineNumber - 1];
                const lineTop = lineElement.offsetTop;
                const containerHeight = codeContainer.clientHeight;
                
                codeContainer.scrollTo({
                    top: lineTop - containerHeight / 2,
                    behavior: 'smooth'
                });
            }
        }
        
        // 重置代码高亮
        function resetCodeHighlight() {
            codeLines.forEach(line => {
                line.classList.remove('highlight');
            });
        }
        
        // 更新统计表格
        function updateStatsTable() {
            statsBody.innerHTML = '';
            
            statsData.forEach((stat, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${stat.pass}</td>
                    <td>${stat.comparisons}</td>
                    <td>${stat.swaps}</td>
                    <td>${stat.line}</td>
                    <td>${stat.time} ms</td>
                `;
                
                statsBody.appendChild(row);
            });
        }
        
        // 更新统计摘要
        function updateSummary() {
            if (animationSteps.length === 0) {
                summaryDisplay.innerHTML = '';
                return;
            }
            
            const lastStep = animationSteps[animationSteps.length - 1];
            
            summaryDisplay.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">总比较次数:</div>
                    <div class="summary-value">${lastStep.comparisons}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">总交换次数:</div>
                    <div class="summary-value">${lastStep.swaps}</div>
                </div>
            `;
        }
        
        // 保存笔记
        function saveNotes() {
            const notes = notesTextarea.value;
            if (!notes) {
                alert('笔记内容为空');
                return;
            }
            
            const blob = new Blob([notes], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '冒泡排序笔记.txt';
            a.click();
            URL.revokeObjectURL(url);
            
            // 语音提示
            if (speechEnabled) {
                speak('笔记已保存');
            }
        }
        
        // 加载笔记
        function loadNotes() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'text/plain';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = event => {
                    notesTextarea.value = event.target.result;
                    
                    // 语音提示
                    if (speechEnabled) {
                        speak('笔记已加载');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // 清空笔记
        function clearNotes() {
            if (confirm('确定要清空笔记吗？')) {
                notesTextarea.value = '';
                
                // 语音提示
                if (speechEnabled) {
                    speak('笔记已清空');
                }
            }
        }
        
        // 切换语音
        function toggleVoice() {
            speechEnabled = voiceToggle.checked;
            
            // 语音提示
            if (speechEnabled && speechSynthesis) {
                speak('语音讲解已启用');
            }
        }
        
        // 语音播报
        function speak(text) {
            if (!speechEnabled || !speechSynthesis) return;
            
            // 取消当前正在进行的语音
            speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN';
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
        }
        
        // 新增学习辅助功能函数
        
        // 显示标记弹出窗口
        function showMarkPopup() {
            if (!isStarted) {
                alert('请先开始排序演示');
                return;
            }
            
            if (currentStep >= animationSteps.length) {
                alert('排序已完成，无法标记');
                return;
            }
            
            const currentStepData = animationSteps[currentStep];
            let infoHTML = `
                <div><strong>当前操作:</strong> ${currentStepData.op}</div>
                <div><strong>执行行号:</strong> ${currentStepData.line}</div>
            `;
            
            if (currentStepData.type === 'compare' || currentStepData.type === 'swap') {
                const [i, j] = currentStepData.indices;
                infoHTML += `
                    <div><strong>比较元素:</strong> ${currentArray[i]} 和 ${currentArray[j]}</div>
                `;
            }
            
            if (currentStepData.pass) {
                infoHTML += `<div><strong>当前趟数:</strong> ${currentStepData.pass}</div>`;
            }
            
            markInfo.innerHTML = infoHTML;
            markTextarea.value = '';
            markPopup.style.display = 'block';
        }
        
        // 关闭标记弹出窗口
        function closeMarkPopup() {
            markPopup.style.display = 'none';
        }
        
        // 保存标记
        function saveMark() {
            const note = markTextarea.value.trim();
            if (!note) {
                alert('请输入标记内容');
                return;
            }
            
            const currentStepData = animationSteps[currentStep];
            const mark = {
                id: Date.now(),
                step: currentStep,
                line: currentStepData.line,
                operation: currentStepData.op,
                array: [...currentArray],
                note: note,
                timestamp: new Date().toLocaleString(),
                pass: currentStepData.pass || 0,
                type: currentStepData.type,
                indices: currentStepData.indices || []
            };
            
            marks.push(mark);
            saveMarks();
            
            // 添加到笔记区域
            const noteText = `[标记] ${currentStepData.op} (行号: ${currentStepData.line}): ${note}\n`;
            notesTextarea.value += noteText;
            
            // 高亮当前步骤
            renderBars();
            
            closeMarkPopup();
            
            // 语音提示
            if (speechEnabled) {
                speak('标记已保存');
            }
        }
        
        // 保存标记到本地存储
        function saveMarks() {
            localStorage.setItem('bubbleSortMarks', JSON.stringify(marks));
        }
        
        // 显示标记列表
        function showMarkList() {
            renderMarkList();
            markList.style.display = 'block';
        }
        
        // 关闭标记列表
        function closeMarkList() {
            markList.style.display = 'none';
        }
        
        // 渲染标记列表
        function renderMarkList() {
            markListContent.innerHTML = '';
            
            if (marks.length === 0) {
                markListContent.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">暂无标记记录</div>';
                return;
            }
            
            marks.forEach(mark => {
                const markItem = document.createElement('div');
                markItem.className = 'mark-item';
                markItem.dataset.id = mark.id;
                
                markItem.innerHTML = `
                    <div class="mark-item-title">${mark.operation}</div>
                    <div class="mark-item-desc">${mark.note}</div>
                    <div class="mark-item-time">${mark.timestamp}</div>
                `;
                
                markItem.addEventListener('click', function() {
                    jumpToMark(mark);
                });
                
                markListContent.appendChild(markItem);
            });
        }
        
        // 跳转到标记位置
        function jumpToMark(mark) {
            // 重置排序状态
            resetAll();
            
            // 开始排序
            startSorting();
            
            // 自动执行到标记的步骤
            let interval = setInterval(() => {
                if (currentStep >= mark.step) {
                    clearInterval(interval);
                    renderBars();
                    
                    // 显示标记内容
                    alert(`标记内容: ${mark.note}\n\n操作: ${mark.operation}\n行号: ${mark.line}`);
                } else {
                    stepForward();
                }
            }, 300);
        }
        
        // 显示步骤的标记详情
        function showMarkDetailsForStep(step) {
            const stepMarks = marks.filter(mark => mark.step === step);
            if (stepMarks.length === 0) return;
            
            let message = '该步骤的标记:\n\n';
            stepMarks.forEach((mark, index) => {
                message += `${index + 1}. ${mark.note}\n\n`;
            });
            
            alert(message);
        }
        
        // 初始化应用
        init();
    </script>
</body>
</html>